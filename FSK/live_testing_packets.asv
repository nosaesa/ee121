%%
close all;
clear all;
clc;
%% Chirping Derping Sending Shiz
fs = 48000;
fc = 400;
lenchirp = 0.6;
t = [0:fs*lenchirp-1]/fs;
f_of_t = 20+t/16*(20000-20);
s_chirp= sin(2*pi*f_of_t.*t)*.5;
%sound(s_chirp,fs);
r = 3;
y = [];
%Number of symbols being sent per packet
n = 20;

%Number of periods for tones to last
D = 20;
T = D/fc;
% Generate random bit string and encode
sent = randi([1 2^r],1,n);

index = 0;
for bit = sent
    if mod(index,20) == 0
        y = [y s_chirp];
    end
    y = [y repmat(encodeFSK(bit,r,fc,fs),1,D)];
    index = index + 1;
end
signal = y;

%%
C = makeCodebook(r,fc,fs,D);
ar = audiorecorder(fs,16,1);
numSym = 20;
numPack = 1;
time = 2;
%%
record(ar), pause(time), stop(ar);
% record(ar),sound(signal,fs),stop(ar);
rcv = getaudiodata(ar);
%%
w = synchronizationRXPackets(rcv,fs,lenchirp,numPack,D,fc,numSym);
b = zeros(numPack,numSym);
for i = 1:numPack
    y = w(i,:);
    pad = ceil(length(y)/(T*fs));
    y = [y; zeros(pad*T*fs - length(y),1)];
    q = reshape(y,T*fs,length(y)/(T*fs));
    for j = 1:numSym
        b(i,j) = decodeFSKSync(q(:,j),r,fc,fs,C,D);
    end
end